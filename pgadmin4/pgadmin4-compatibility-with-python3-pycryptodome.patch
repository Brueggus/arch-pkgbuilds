From 058fe07217d40551195f0d54e9f76c9a20c13d91 Mon Sep 17 00:00:00 2001
From: anthraxx <levente@leventepolyak.net>
Date: Tue, 13 Nov 2018 17:54:21 +0100
Subject: [PATCH] compatibility with python3 pycryptodome

---
 web/pgadmin/utils/crypto.py                     | 4 ++--
 web/pgadmin/utils/driver/psycopg2/connection.py | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/web/pgadmin/utils/crypto.py b/web/pgadmin/utils/crypto.py
index 8350f7a1..74633493 100644
--- a/web/pgadmin/utils/crypto.py
+++ b/web/pgadmin/utils/crypto.py
@@ -28,12 +28,12 @@ def encrypt(plaintext, key):
     """
 
     iv = Random.new().read(AES.block_size)
-    cipher = AES.new(pad(key), AES.MODE_CFB, iv)
+    cipher = AES.new(pad(key.encode('utf-8')), AES.MODE_CFB, iv)
     # If user has entered non ascii password (Python2)
     # we have to encode it first
     if hasattr(str, 'decode'):
         plaintext = plaintext.encode('utf-8')
-    encrypted = base64.b64encode(iv + cipher.encrypt(plaintext))
+    encrypted = base64.b64encode(iv + cipher.encrypt(plaintext.encode('utf-8')))
 
     return encrypted
 
diff --git a/web/pgadmin/utils/driver/psycopg2/connection.py b/web/pgadmin/utils/driver/psycopg2/connection.py
index 4f11c12b..e5fdd31f 100644
--- a/web/pgadmin/utils/driver/psycopg2/connection.py
+++ b/web/pgadmin/utils/driver/psycopg2/connection.py
@@ -256,7 +256,7 @@ class Connection(BaseConnection):
                 return False, gettext("Unauthorized request.")
 
             try:
-                password = decrypt(encpass, user.password)
+                password = decrypt(encpass, user.password.encode('utf-8'))
                 # Handling of non ascii password (Python2)
                 if hasattr(str, 'decode'):
                     password = password.decode('utf-8').encode('utf-8')
-- 
2.19.1

